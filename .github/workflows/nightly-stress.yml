name: Nightly Mock Stress

on:
  schedule:
    - cron: "30 3 * * *"
  workflow_dispatch:

concurrency:
  group: nightly-stress-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  smoke:
    runs-on: ubuntu-22.04
    timeout-minutes: 40
    env:
      CARGO_TERM_COLOR: always
      RESTFLOW_TEST_MODE: "1"
      SOAK_MINUTES: "6"
      LOG_DIR: ${{ github.workspace }}/target/stress-artifacts

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          components: clippy

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-nightly-stress-${{ hashFiles('Cargo.lock') }}

      - name: Run core stress integration test (smoke)
        run: cargo test -p restflow-core --features test-utils --test stress_mock_runtime -- --nocapture

      - name: Run MCP background-agent stress path
        run: cargo test -p restflow-core mcp::server::tests::test_mcp_manage_background_agents_stress_path_emits_latency_summary -- --nocapture

      - name: Run AI context manager stress tests
        run: cargo test -p restflow-ai --features test-utils --test stress_context_manager -- --nocapture

      - name: Validate stress summary threshold
        run: |
          python3 - <<'PY'
          import json
          import os
          from pathlib import Path

          def resolve_artifact(filename: str) -> Path:
              log_dir = Path(os.environ.get("LOG_DIR", "target/stress-artifacts"))
              candidates = [
                  log_dir / filename,
                  Path("target/stress-artifacts") / filename,
                  Path("crates/restflow-core/target/stress-artifacts") / filename,
              ]
              for path in candidates:
                  if path.exists():
                      return path
              checked = ", ".join(str(path) for path in candidates)
              raise SystemExit(f"{filename} not found (checked: {checked})")

          summary_path = resolve_artifact("stress-summary.json")
          mcp_summary_path = resolve_artifact("mcp-background-agent-stress-summary.json")

          summary = json.loads(summary_path.read_text(encoding="utf-8"))
          mcp_summary = json.loads(mcp_summary_path.read_text(encoding="utf-8"))
          panic_count = int(summary.get("panic_count", 0))
          success_rate = float(summary.get("success_rate", 0.0))
          p95 = int(mcp_summary.get("latency_ms", {}).get("p95", 0))

          if panic_count != 0:
              raise SystemExit(f"panic_count must be 0, got {panic_count}")
          # DeterministicMockExecutor fails every 10th task â†’ 60 tasks = 6 failures = 0.90 rate
          if success_rate < 0.89:
              raise SystemExit(f"success_rate must be >= 0.89, got {success_rate:.4f}")
          if p95 > 250:
              raise SystemExit(f"mcp p95 must be <= 250ms, got {p95}ms")

          print(f"Summary validated: panic_count={panic_count}, success_rate={success_rate:.4f}, p95={p95}ms")

          # Context manager stress summary (optional - may not exist on first run)
          try:
              ctx_path = resolve_artifact("context-manager-stress-summary.json")
              ctx = json.loads(ctx_path.read_text(encoding="utf-8"))
              sections = [k for k in ctx if k != "suite"]
              print(f"Context manager stress: {len(sections)} sections completed")
              for section in sections:
                  test_name = ctx[section].get("test", section)
                  elapsed = ctx[section].get("elapsed_ms", ctx[section].get("elapsed_us", "N/A"))
                  print(f"  - {test_name}: elapsed={elapsed}")
          except SystemExit:
              print("Context manager stress summary not found, skipping (non-blocking)")
          PY

      - name: Smoke summary
        if: always()
        run: |
          {
            echo "## Nightly Stress Smoke"
            echo ""
            echo "- stress_mock_runtime: executed"
            echo "- mcp stress path: executed"
            if [ -f "${LOG_DIR}/stress-summary.json" ]; then
              echo "- stress-summary.json: available"
            fi
            if [ -f "${LOG_DIR}/mcp-background-agent-stress-summary.json" ]; then
              echo "- mcp-background-agent-stress-summary.json: available"
            fi
            if [ -f "${LOG_DIR}/context-manager-stress-summary.json" ] || [ -f "target/stress-artifacts/context-manager-stress-summary.json" ]; then
              echo "- context-manager-stress-summary.json: available"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload smoke artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-stress-smoke-artifacts
          path: |
            ${{ env.LOG_DIR }}/**
            target/stress-artifacts/**
            crates/restflow-core/target/stress-artifacts/**
          if-no-files-found: warn

  stress:
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    needs: smoke
    env:
      CARGO_TERM_COLOR: always
      RESTFLOW_TEST_MODE: "1"
      SOAK_MINUTES: "12"
      LOG_DIR: ${{ github.workspace }}/target/stress-artifacts

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          components: clippy

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-nightly-stress-${{ hashFiles('Cargo.lock') }}

      - name: Run AI crate tests
        run: cargo test -p restflow-ai --verbose

      - name: Run mock soak script (stress profile)
        run: bash scripts/stress/mock_daemon_soak.sh

      - name: Stress summary
        if: always()
        run: |
          echo "## Nightly Stress Medium" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ -f "${LOG_DIR}/stress-summary.json" ]; then
            python3 - <<'PY' >> "$GITHUB_STEP_SUMMARY"
          import json
          from pathlib import Path
          import os
          summary = json.loads(Path(os.environ["LOG_DIR"]).joinpath("stress-summary.json").read_text(encoding="utf-8"))
          print(f"- total_runs: {summary.get('total_runs')}")
          print(f"- success: {summary.get('success')}")
          print(f"- failure: {summary.get('failure')}")
          print(f"- warn_count: {summary.get('warn_count', 0)}")
          print(f"- hard_limit_breaches: {summary.get('hard_limit_breaches', 0)}")
          PY
          else
            echo "- stress-summary.json missing" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload stress artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-stress-medium-artifacts
          path: |
            ${{ env.LOG_DIR }}/**
            target/stress-artifacts/**
            crates/restflow-core/target/stress-artifacts/**
          if-no-files-found: warn

  soak:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    needs: stress
    env:
      CARGO_TERM_COLOR: always
      RESTFLOW_TEST_MODE: "1"
      SOAK_MINUTES: "120"
      METRIC_INTERVAL_SECONDS: "60"
      LOG_DIR: ${{ github.workspace }}/target/stress-artifacts

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true
          components: clippy

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-nightly-stress-${{ hashFiles('Cargo.lock') }}

      - name: Run mock soak script (soak profile)
        run: bash scripts/stress/mock_daemon_soak.sh

      - name: Soak summary
        if: always()
        run: |
          {
            echo "## Nightly Stress Soak"
            echo ""
            if [ -f "${LOG_DIR}/soak-summary.md" ]; then
              cat "${LOG_DIR}/soak-summary.md"
            else
              echo "- soak-summary.md missing"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload soak artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-stress-soak-artifacts
          path: |
            ${{ env.LOG_DIR }}/**
            target/stress-artifacts/**
            crates/restflow-core/target/stress-artifacts/**
          if-no-files-found: warn
